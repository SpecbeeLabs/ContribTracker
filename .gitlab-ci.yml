stages:
- build
- test
- deploy

drupal_codequality:
  image: hussainweb/drupalqa:php7.3
  stage: test
  script:
    - phpcs --standard=Drupal --extensions=php,module,inc,install,test,profile,theme --ignore=/node_modules/ web/modules/custom
    - phpcs --standard=DrupalPractice --extensions=php,module,inc,install,test,profile,theme --ignore=/node_modules/ web/modules/custom
    - phpmd web/modules/custom/ text phpmd.xml
  tags:
    - docker

drupal_tests:
  image: hussainweb/drupal-base:php7.3
  services:
    - mariadb:10.3
  stage: test
  tags:
    - docker
  variables:
    SITE_BASE_URL: 'http://localhost'
    MYSQL_DATABASE: "contrib"
    MYSQL_ROOT_PASSWORD: "contrib123"

  before_script:
    # Install MySQL ourselves for now.
    - apt-get update && apt-get install mariadb-client -y
    - curl https://www.dropbox.com/s/6yamghdnewls2bo/contrib-tracker-db.sql.gz?dl=1 -L --output contrib-tracker-db.sql.gz
    - gunzip < contrib-tracker-db.sql.gz | mysql --user=root --password="$MYSQL_ROOT_PASSWORD" --host=mariadb "$MYSQL_DATABASE"
    - ./scripts/gitlab/ci.sh

  script:
    - composer install -o

    # Clearing drush cache and importing configs
    - ./vendor/drush/drush/drush cr
    - ./vendor/drush/drush/drush -y updatedb
    - ./vendor/drush/drush/drush -y config-import

    #  Phpunit execution
    - ./vendor/bin/phpunit --bootstrap=./vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php --configuration ./phpunit.xml --testsuite existing-site

platformsh:
  image: axelerant/platformsh-cli:latest
  stage: deploy
  variables:
    PLATFORMSH_CLI_UPDATES_CHECK: '0'
    PF_PARENT_ENV: "master"
    ALLOW_MASTER: '0'
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  script:
    - platform project:set-remote ${PLATFORM_PROJECT_ID}
    - platform push --verbose --force --activate --target ${CI_COMMIT_REF_NAME}
  tags:
    - docker
