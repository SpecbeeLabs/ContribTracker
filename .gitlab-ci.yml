stages:
- build
- test
- deploy

drupal_codequality:
  image: hussainweb/drupalqa:latest
  stage: test
  script:
    - phpcs --standard=Drupal --extensions=php,module,inc,install,test,profile,theme --ignore=/node_modules/ web/modules/custom
    - phpcs --standard=DrupalPractice --extensions=php,module,inc,install,test,profile,theme --ignore=/node_modules/ web/modules/custom
    - phpmd web/modules/custom/ text cleancode,codesize,design,naming,unusedcode
  tags:
    - autoscaler

platformsh:
  image: pjcdawkins/platformsh-cli:latest
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  variables:
    PLATFORMSH_CLI_UPDATES_CHECK: '0'
    PF_PARENT_ENV: "master"
    ALLOW_MASTER: '0'
  stage: deploy
  script:
    - platform project:set-remote ${PLATFORM_PROJECT_ID}
    - platform push --verbose --activate --target ${CI_COMMIT_REF_NAME}
  tags:
    - autoscaler
